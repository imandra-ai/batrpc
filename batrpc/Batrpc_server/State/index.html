<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>State (batrpc.Batrpc_server.State)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">batrpc</a> &#x00BB; <a href="../index.html">Batrpc_server</a> &#x00BB; State</nav><header class="odoc-preamble"><h1>Module <code><span>Batrpc_server.State</span></code></h1><p>Server side for a given connection.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div><div class="spec-doc"><p>Server side for a given connection to a client</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><a href="../../../ocaml/Stdlib/Format/index.html#type-formatter">Stdlib.Format.formatter</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show"><a href="#val-show" class="anchor"></a><code><span><span class="keyword">val</span> show : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-handler"><a href="#type-handler" class="anchor"></a><code><span><span class="keyword">type</span> handler</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-with_ctx"><a href="#type-with_ctx" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a with_ctx</span></span><span> = <a href="../../Batrpc_core/Handler/index.html#type-ctx">Batrpc_core.Handler.ctx</a> * <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mk_handler"><a href="#val-mk_handler" class="anchor"></a><code><span><span class="keyword">val</span> mk_handler : 
  <span><span><span>(<span class="type-var">'req</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>,
    <span class="type-var">'res</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>)</span>
    <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-rpc">Batrpc_core.Service.Server.rpc</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span class="type-var">'req</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'res</span> <a href="../../../imandrakit/Imandrakit_thread/Fut/index.html#type-t">Imandrakit_thread.Fut.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Make a simple request/reply handler</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mk_handler_full"><a href="#val-mk_handler_full" class="anchor"></a><code><span><span class="keyword">val</span> mk_handler_full : 
  <span><span><span>(<span class="type-var">'req</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>,
    <span class="type-var">'res</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>)</span>
    <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-rpc">Batrpc_core.Service.Server.rpc</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span class="type-var">'req</span> <a href="#type-with_ctx">with_ctx</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'res</span> <a href="#type-with_ctx">with_ctx</a></span> <a href="../../../imandrakit/Imandrakit_thread/Fut/index.html#type-t">Imandrakit_thread.Fut.t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Make a full request/reply handler, with headers</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mk_client_stream_handler"><a href="#val-mk_client_stream_handler" class="anchor"></a><code><span><span class="keyword">val</span> mk_client_stream_handler : 
  <span><span><span>(<span class="type-var">'req</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-stream">Batrpc_core.Service.Value_mode.stream</a>,
    <span class="type-var">'res</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>)</span>
    <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-rpc">Batrpc_core.Service.Server.rpc</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">init</span>:<span>(<span><span>unit <a href="#type-with_ctx">with_ctx</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'state</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">on_item</span>:<span>(<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'req</span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">on_close</span>:<span>(<span><span class="type-var">'state</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'res</span> <a href="#type-with_ctx">with_ctx</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Make a handler for client-stream requests. The handler is a state machine that reacts to new stream elements and returns a response upon stream closure.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mk_server_stream_handler"><a href="#val-mk_server_stream_handler" class="anchor"></a><code><span><span class="keyword">val</span> mk_server_stream_handler : 
  <span><span><span>(<span class="type-var">'req</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-unary">Batrpc_core.Service.Value_mode.unary</a>,
    <span class="type-var">'res</span>,
    <a href="../../../pbrt_services/Pbrt_services/Value_mode/index.html#type-stream">Batrpc_core.Service.Value_mode.stream</a>)</span>
    <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-rpc">Batrpc_core.Service.Server.rpc</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><span><span class="type-var">'req</span> <a href="#type-with_ctx">with_ctx</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'res</span> <a href="../../Batrpc_core/Push_stream/index.html#type-t">Batrpc_core.Push_stream.t</a></span> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-handler">handler</a></span></code></div><div class="spec-doc"><p>Make a handler for server-stream. The handler can push values back to the client. The request ends when the stream is closed by the handler.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?middlewares</span>:<span><a href="../Middleware/index.html#type-t">Middleware.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">services</span>:<span><span><a href="#type-handler">handler</a> <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-t">Batrpc_core.Service.Server.t</a></span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">framing_config</span>:<a href="../../Batrpc_core/Framing/index.html#type-config">Batrpc_core.Framing.config</a> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_middleware"><a href="#val-add_middleware" class="anchor"></a><code><span><span class="keyword">val</span> add_middleware : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Middleware/index.html#type-t">Middleware.t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_service"><a href="#val-add_service" class="anchor"></a><code><span><span class="keyword">val</span> add_service : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-handler">handler</a> <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-t">Batrpc_core.Service.Server.t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-list_services"><a href="#val-list_services" class="anchor"></a><code><span><span class="keyword">val</span> list_services : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-handler">handler</a> <a href="../../../pbrt_services/Pbrt_services/Server/index.html#type-t">Batrpc_core.Service.Server.t</a></span> list</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_meth"><a href="#val-find_meth" class="anchor"></a><code><span><span class="keyword">val</span> find_meth : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(string * <a href="#type-handler">handler</a>)</span> option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-send_heartbeat"><a href="#val-send_heartbeat" class="anchor"></a><code><span><span class="keyword">val</span> send_heartbeat : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">encoding</span>:<a href="../../Batrpc_core/Encoding/index.html#type-t">Batrpc_core.Encoding.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">oc</span>:<span><a href="../../Batrpc_core/Io/Out/class-type-t/index.html">Batrpc_core.Io.Out.t</a> <a href="../../../imandrakit/Imandrakit_thread/Lock/index.html#type-t">Imandrakit_thread.Lock.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Send a heartbeat message</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_request"><a href="#val-handle_request" class="anchor"></a><code><span><span class="keyword">val</span> handle_request : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">encoding</span>:<a href="../../Batrpc_core/Encoding/index.html#type-t">Batrpc_core.Encoding.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">runner</span>:<a href="../../../moonpool/Moonpool/Runner/index.html#type-t">Batrpc_core.Runner.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">meta</span>:<a href="../../Batrpc_core/Meta/index.html#type-meta">Batrpc_core.Meta.meta</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ic</span>:<a href="../../Batrpc_core/Io/In/class-type-t/index.html">Batrpc_core.Io.In.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">oc</span>:<span><a href="../../Batrpc_core/Io/Out/class-type-t/index.html">Batrpc_core.Io.Out.t</a> <a href="../../../imandrakit/Imandrakit_thread/Lock/index.html#type-t">Imandrakit_thread.Lock.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>We have read, from <code>ic</code>, the metadata for a new message of type <code>Meta.Request</code>. Handle this by running (in the current thread) the corresponding handler and reply to it.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">runner</span> <p>where to spawn the handler for this request?</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_stream_item"><a href="#val-handle_stream_item" class="anchor"></a><code><span><span class="keyword">val</span> handle_stream_item : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">encoding</span>:<a href="../../Batrpc_core/Encoding/index.html#type-t">Batrpc_core.Encoding.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">meta</span>:<a href="../../Batrpc_core/Meta/index.html#type-meta">Batrpc_core.Meta.meta</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ic</span>:<a href="../../Batrpc_core/Io/In/class-type-t/index.html">Batrpc_core.Io.In.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">oc</span>:<span><a href="../../Batrpc_core/Io/Out/class-type-t/index.html">Batrpc_core.Io.Out.t</a> <a href="../../../imandrakit/Imandrakit_thread/Lock/index.html#type-t">Imandrakit_thread.Lock.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Handle stream close, in the current thread. We must preserve the order of processing.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-handle_stream_close"><a href="#val-handle_stream_close" class="anchor"></a><code><span><span class="keyword">val</span> handle_stream_close : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">encoding</span>:<a href="../../Batrpc_core/Encoding/index.html#type-t">Batrpc_core.Encoding.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">meta</span>:<a href="../../Batrpc_core/Meta/index.html#type-meta">Batrpc_core.Meta.meta</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">ic</span>:<a href="../../Batrpc_core/Io/In/class-type-t/index.html">Batrpc_core.Io.In.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">oc</span>:<span><a href="../../Batrpc_core/Io/Out/class-type-t/index.html">Batrpc_core.Io.Out.t</a> <a href="../../../imandrakit/Imandrakit_thread/Lock/index.html#type-t">Imandrakit_thread.Lock.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div><div class="spec-doc"><p>Handle stream close, in the current thread. We must preserve the order of processing.</p></div></div></div></body></html>
